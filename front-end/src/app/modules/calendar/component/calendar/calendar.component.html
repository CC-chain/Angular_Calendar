
<div [ngClass]="theme">
<app-calendar-header
  [(view)]="view"
  [(viewDate)]="viewDate"
  (viewDateChange)="fetchEvents()"
  (viewChange)="fetchEvents()"
  [theme]="theme"></app-calendar-header>
<br />
<ng-template #loading>
  <div class="text-center">
    <i class="fas fa-spin fa-spinner fa-5x"></i> <br />
    Loading events...
  </div>
</ng-template>

<context-menu #eventMenu>
  <ng-template contextMenuItem (execute)="editEventContext($event)">
    Edit event
  </ng-template>
  <ng-template contextMenuItem (execute)="deleteEventContext($event)">
    Delete event
  </ng-template>
</context-menu>

<context-menu #segmentMenu>
  <ng-template contextMenuItem (execute)="addEventContext($event)">
    Add Event
  </ng-template>
</context-menu>


<ng-template
  #weekViewHourSegment
  let-segment="segment"
  let-locale="locale"
  let-segmentHeight="segmentHeight"
  let-isTimeLabel="isTimeLabel"
  let-daysInWeek="daysInWeek">
  <div
    [attr.aria-hidden]="{}
    | calendarA11y
    : (daysInWeek === 1
    ? 'hideDayHourSegment'
    : 'hideWeekHourSegment')" class="cal-hour-segment"
    [style.height.px]="segmentHeight"
    [class.cal-hour-start]="segment.isStart"
    [class.cal-after-hour-start]="!segment.isStart"
    [ngClass]="segment.cssClass"
    [contextMenu]="segmentMenu"
    [contextMenuSubject]="segment.date">
    <div class="cal-time" *ngIf="isTimeLabel">
      {{
      segment.displayDate
      | calendarDate
      : (daysInWeek === 1 ? 'dayViewHour' : 'weekViewHour')
      : locale
      }}
    </div>
  </div>
</ng-template>

<ng-template
  #weekHeaderTemplate
  let-days="days"
  let-locale="locale"
  let-dayHeaderClicked="dayHeaderClicked"
  let-eventDropped="eventDropped"
  let-trackByWeekDayHeaderDate="trackByWeekDayHeaderDate"
  let-dragEnter="dragEnter">
  <div class="cal-day-headers" role="row">
    <div
      class="cal-header"
      *ngFor="let day of days; trackBy: trackByWeekDayHeaderDate"
      [class.cal-past]="day.isPast"
      [class.cal-today]="day.isToday"
      [class.cal-future]="day.isFuture"
      [class.cal-weekend]="day.isWeekend"
      [ngClass]="day.cssClass"
      [contextMenu]="eventMenu"
      [contextMenuSubject]="day.date"
      (mwlClick)="dayHeaderClicked.emit({ day: day, sourceEvent: $event })"
      mwlDroppable
      dragOverClass="cal-drag-over"
      (drop)="eventDropped.emit({
      event: $event.dropData.event,
      newStart: day.date
      })" (dragEnter)="dragEnter.emit({ date: day.date })"
      tabindex="0"
      role="columnheader">
      <b>{{ day.date | calendarDate: 'weekViewColumnHeader':locale }}</b><br />
      <span>{{
        day.date | calendarDate: 'weekViewColumnSubHeader':locale
        }}</span>
    </div>
  </div>
</ng-template>


<ng-template
  #weekEventTemplate
  let-weekEvent="weekEvent"
  let-tooltipPlacement="tooltipPlacement"
  let-eventClicked="eventClicked"
  let-tooltipTemplate="tooltipTemplate"
  let-tooltipAppendToBody="tooltipAppendToBody"
  let-tooltipDisabled="tooltipDisabled"
  let-tooltipDelay="tooltipDelay"
  let-column="column"
  let-daysInWeek="daysInWeek"
  let-locale="locale">
  <div
    class="cal-event"
    [ngStyle]="{
    backgroundColor: weekEvent.event.color?.secondary,
    borderColor: weekEvent.event.color?.primary
    }"
    [mwlCalendarTooltip]="!tooltipDisabled
    ? (weekEvent.event.title
    | calendarEventTitle
    : (daysInWeek === 1 ? 'dayTooltip' : 'weekTooltip')
    : weekEvent.tempEvent || weekEvent.event)
    : ''" [tooltipPlacement]="tooltipPlacement"
    [tooltipEvent]="weekEvent.tempEvent || weekEvent.event"
    [tooltipTemplate]="tooltipTemplate"
    [tooltipAppendToBody]="tooltipAppendToBody"
    [tooltipDelay]="tooltipDelay"
    (mwlClick)="eventClicked.emit({ sourceEvent: $event })"
    (mwlKeydownEnter)="eventClicked.emit({ sourceEvent: $event })"
    [contextMenu]="eventMenu"
    [contextMenuSubject]="weekEvent.event"
    tabindex="0"
    role="application"
    [attr.aria-label]="{ event: weekEvent.tempEvent || weekEvent.event, locale:
    locale }
    | calendarA11y: 'eventDescription'">
    <mwl-calendar-event-actions
      [event]="weekEvent.tempEvent || weekEvent.event">
    </mwl-calendar-event-actions>
    &ngsp;
    <mwl-calendar-event-title
      [event]="weekEvent.tempEvent || weekEvent.event"
      [view]="daysInWeek === 1 ? 'day' : 'week'">
    </mwl-calendar-event-title>
  </div>
</ng-template>


<div *ngIf="events$ | async; else loading; let events">
  <div [ngSwitch]="view">
    <mwl-calendar-month-view
      *ngSwitchCase="CalendarView.Month"
      [viewDate]="viewDate"
      [events]="events"
      [refresh]="refresh"
      [activeDayIsOpen]="false"
      [locale]="locale"
      (eventTimesChanged)="eventTimesChanged($event)">
    </mwl-calendar-month-view>
    <mwl-calendar-week-view
      *ngSwitchCase="CalendarView.Week"
      [viewDate]="viewDate"
      [precision]="'minutes'"
      [events]="events"
      [refresh]="refresh"
      [locale]="locale"
      [hourDuration]="20"
      [hourSegments]="1"
      (eventTimesChanged)="eventTimesChanged($event)"
      [hourSegmentTemplate]="weekViewHourSegment"
      [headerTemplate]="weekHeaderTemplate"
      [eventTemplate]="weekEventTemplate"
      [validateEventTimesChanged]="validateEventTimesChanged"
      (beforeViewRender)="beforeWeekOrDayViewRender($event)"
      (hourSegmentClicked)="hourSegmentClicked($event.date)">
    </mwl-calendar-week-view>
    <mwl-calendar-day-view
      *ngSwitchCase="CalendarView.Day"
      [viewDate]="viewDate"
      [locale]="locale"
      [events]="events"
      [refresh]="refresh"
      [validateEventTimesChanged]="validateEventTimesChanged"
      (eventTimesChanged)="eventTimesChanged($event)"
      (beforeViewRender)="beforeWeekOrDayViewRender($event)"
      (hourSegmentClicked)="hourSegmentClicked($event.date)">
    </mwl-calendar-day-view>
  </div>

  <ng-template #modalEdit let-close="close">
    <app-calendar-edit [modalData]="dataService.modalData"
      (onChangeEvent)="editEvents($event)">
      <button type="button" class="close" (click)="close()">
        <span aria-hidden="true">&times;</span>
      </button>
    </app-calendar-edit>
  </ng-template>
  <ng-template #modalRemove let-close="close">
    <div class="modal-header">
      <h3 class="modal-title">Removing {{dataService.modalData.event.title}}</h3>
      <button type="button" class="close btn" (click)="close()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body">
      <p>Are you sure ?</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-danger"
        (click)="deleteEvent(dataService.modalData.event)">Remove</button>
      <button type="button" class="btn btn-secondary" (click)="close()">Close</button>
    </div>
  </ng-template>
  <ng-template #modalAdd let-close="close">
    <app-calendar-edit [modalData]="dataService.modalData"
      (onChangeEvent)="addEvent($event)">
      <button type="button" class="close" (click)="close()">
        <span aria-hidden="true">&times;</span>
      </button>
    </app-calendar-edit>
  </ng-template>

  </div>
  </div>
